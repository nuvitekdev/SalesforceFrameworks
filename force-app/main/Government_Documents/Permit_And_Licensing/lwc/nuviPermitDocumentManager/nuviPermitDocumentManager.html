<template>
  <lightning-card title="Permit Document Manager" icon-name="doctype:folder" class="nuvi-card">
    <!-- Toolbar -->
    <div class="slds-p-around_small slds-grid slds-grid_align-spread slds-wrap">
      <div class="slds-col slds-m-bottom_x-small">
        <lightning-button variant="neutral" label="Back to Folders" onclick={handleBackToFolders} disabled={isInFolderView}></lightning-button>
      </div>
      <div class="slds-col slds-m-bottom_x-small">
        <template if:true={showFolderCreation}>
          <lightning-button variant="brand" label="Create Folder Structure" onclick={handleCreateFolderStructure}></lightning-button>
        </template>
      </div>
      <div class="slds-col slds-m-bottom_x-small">
        <lightning-combobox label="View" value={viewMode} options={viewModeOptions} onchange={handleViewModeChange}></lightning-combobox>
      </div>
      <div class="slds-col slds-m-bottom_x-small slds-grow">
        <lightning-input type="search" label="Search files" value={searchTerm} onchange={handleSearch}></lightning-input>
      </div>
    </div>

    <!-- Folder View -->
    <template if:true={isInFolderView}>
      <div class="slds-p-horizontal_small slds-p-bottom_small">
        <div class="slds-grid slds-wrap slds-gutters">
          <template for:each={permitFolders} for:item="folder">
            <div key={folder.name} class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-p-vertical_small">
              <lightning-tile label={folder.name} onclick={handleFolderSelect} data-folder={folder.name}>
                <p class="slds-truncate" title="Files">Files: {folder.fileCount}</p>
                <p class="slds-truncate" title="Stage">Stage: {folder.metadata.workflowStage}</p>
              </lightning-tile>
            </div>
          </template>
        </div>
      </div>

      <!-- Compliance Summary -->
      <div class="slds-p-around_small slds-border_top">
        <div class="slds-text-title_caps slds-m-bottom_x-small">Compliance Overview</div>
        <div class="slds-grid slds-wrap slds-gutters_small">
          <template for:each={complianceOverviewItems} for:item="item">
            <div key={item.label} class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
              <div class="slds-box slds-box_xx-small">
                <div class="slds-text-title">{item.label}</div>
                <div class="slds-text-heading_small">{item.value}</div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- File View -->
    <template if:true={isInFileView}>
      <div class="slds-p-around_small slds-border_bottom">
        <div class="slds-grid slds-wrap slds-grid_align-spread slds-m-bottom_small">
          <div class="slds-col">
            <div class="slds-text-heading_small">{currentFolderTitle}</div>
          </div>
          <div class="slds-col">
            <lightning-button variant="brand" label="Upload" onclick={handleUploadClick}></lightning-button>
          </div>
        </div>

        <!-- Upload Modal (simple inline controls for MVP) -->
        <template if:true={showUploadModal}>
          <div class="slds-box slds-theme_default slds-m-bottom_small">
            <div class="slds-text-title_caps slds-m-bottom_small">{uploadModalTitle}</div>
            <div class="slds-grid slds-wrap slds-gutters_small">
              <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                <lightning-combobox
                  label="Document Type"
                  value={selectedDocumentType}
                  options={documentTypeOptions}
                  onchange={handleDocumentTypeChange}
                ></lightning-combobox>
              </div>
              <div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-3">
                <lightning-input
                  type="file"
                  multiple
                  label="Select Files"
                  accept={allowedFileTypes}
                  onchange={handleFileUpload}
                ></lightning-input>
              </div>
            </div>
            <div class="slds-m-top_small">
              <lightning-progress-bar value={uploadProgress}></lightning-progress-bar>
            </div>
            <div class="slds-m-top_small">
              <lightning-button variant="neutral" label="Close" onclick={handleUploadModalClose}></lightning-button>
            </div>
          </div>
        </template>

        <!-- Files list -->
        <template if:true={hasFiles}>
          <div class="slds-grid slds-wrap slds-gutters">
            <template for:each={filteredFiles} for:item="file">
              <div key={file.id} class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-p-vertical_x-small">
                <div class="slds-box slds-box_xx-small">
                  <div class="slds-grid slds-grid_align-spread slds-wrap">
                    <div class="slds-col slds-truncate">
                      <div class="slds-text-title">{file.title}</div>
                      <div class="slds-text-color_weak">Type: {file.documentType} â€¢ Status: {file.status}</div>
                      <div class="slds-text-color_weak">Updated: {file.contentModifiedDate}</div>
                    </div>
                    <div class="slds-col slds-m-left_small">
                      <lightning-button-menu alternative-text="Actions" menu-alignment="right">
                        <lightning-menu-item label="View" value="view" onclick={handleFileSelect} data-file-id={file.id} data-action="view"></lightning-menu-item>
                        <lightning-menu-item label="Move" value="move" onclick={handleFileSelect} data-file-id={file.id} data-action="move"></lightning-menu-item>
                        <lightning-menu-item label="Delete" value="delete" onclick={handleFileSelect} data-file-id={file.id} data-action="delete"></lightning-menu-item>
                        <lightning-menu-item label="AI Details" value="ai-analysis" onclick={handleFileSelect} data-file-id={file.id} data-action="ai-analysis"></lightning-menu-item>
                      </lightning-button-menu>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </template>
        <template if:false={hasFiles}>
          <div class="slds-p-around_small slds-text-color_weak">No files in this folder yet.</div>
        </template>
      </div>
    </template>

    <template if:true={isLoading}>
      <div class="slds-p-around_small"><lightning-spinner alternative-text="Loading"></lightning-spinner></div>
    </template>
  </lightning-card>
  </lightning-card>
</template>
