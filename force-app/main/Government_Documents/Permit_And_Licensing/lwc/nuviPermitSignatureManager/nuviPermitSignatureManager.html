<template>
  <div class="slds-card apd-signature-manager">
    <div class="slds-card__header slds-grid">
      <header class="slds-media slds-media_center slds-has-flexi-truncate">
        <div class="slds-media__figure">
          <lightning-icon icon-name="doctype:pdf" alternative-text="PDF Signature" title="PDF Signature"></lightning-icon>
        </div>
        <div class="slds-media__body">
          <h2 class="slds-card__header-title">
            <span class="slds-text-heading_small">APD Signature: {documentTypeLabel}</span>
          </h2>
          <p class="slds-text-body_small slds-text-color_weak">
            Signer Role: {signerRoleLabel} | Workflow Stage: {workflowStage}
          </p>
        </div>
      </header>
      <div class="slds-no-flex">
        <lightning-button-menu alternative-text="Show menu" menu-alignment="right" variant="border-filled">
          <lightning-menu-item value="help" label="Help & Documentation"></lightning-menu-item>
          <lightning-menu-item value="view-apd" label="View APD Record" onclick={navigateToAPDRecord}></lightning-menu-item>
          <lightning-menu-item value="refresh" label="Refresh Data"></lightning-menu-item>
        </lightning-button-menu>
      </div>
    </div>

    <div class="slds-card__body slds-card__body_inner">
      <!-- Loading Spinner -->
      <template if:true={isLoading}>
        <div class="slds-spinner_container">
          <div role="status" class="slds-spinner slds-spinner_medium">
            <span class="slds-assistive-text">Loading...</span>
            <div class="slds-spinner__dot-a"></div>
            <div class="slds-spinner__dot-b"></div>
          </div>
        </div>
      </template>

      <!-- Step 0: Permission Validation -->
      <template if:true={isStep0}>
        <div class="step-container">
          <div class="slds-text-align_center slds-m-bottom_medium">
            <lightning-icon icon-name="utility:lock" size="large" variant="warning"></lightning-icon>
            <h3 class="slds-text-heading_medium slds-m-top_small">Signature Authorization Check</h3>
          </div>

          <template if:true={hasValidationErrors}>
            <div class="slds-notify slds-notify_alert slds-alert_error slds-m-bottom_medium" role="alert">
              <h2>{errorMessage}</h2>
            </div>
          </template>

          <template if:true={isAuthorizedSigner}>
            <div class="slds-notify slds-notify_alert slds-alert_success slds-m-bottom_medium" role="alert">
              <h2>✓ You are authorized to sign this document type</h2>
            </div>
            <div class="slds-text-align_center">
              <lightning-button variant="brand" label="Proceed to Upload" onclick={handleNextStep}></lightning-button>
            </div>
          </template>

          <template if:false={isAuthorizedSigner}>
            <div class="slds-box slds-theme_error slds-m-bottom_medium">
              <h4 class="slds-text-heading_small">Authorization Required</h4>
              <p>You need the following permissions to sign this document:</p>
              <ul class="slds-m-top_small">
                <template for:each={requiredSignatureSteps} for:item="step">
                  <li key={step} class="slds-m-bottom_x-small">• {step}</li>
                </template>
              </ul>
            </div>
          </template>
        </div>
      </template>

      <!-- Step 1: Document Upload -->
      <template if:true={isStep1}>
        <div class="step-container">
          <div class="slds-text-align_center slds-m-bottom_medium">
            <lightning-icon icon-name="utility:upload" size="large" variant="brand"></lightning-icon>
            <h3 class="slds-text-heading_medium slds-m-top_small">Upload APD Document</h3>
            <p class="slds-text-body_regular slds-text-color_weak">
              Select the PDF document that requires your signature
            </p>
          </div>

          <div class="slds-file-selector slds-file-selector_files">
            <div class="slds-file-selector__dropzone">
              <input type="file" class="slds-file-selector__input slds-assistive-text" 
                     accept=".pdf" id="file-upload-input-01" onchange={handleFileUpload} />
              <label class="slds-file-selector__body" for="file-upload-input-01">
                <span class="slds-file-selector__button slds-button slds-button_neutral">
                  <lightning-icon icon-name="utility:upload" size="small"></lightning-icon>
                  Upload PDF Document
                </span>
                <span class="slds-file-selector__text slds-medium-show">or drop file here</span>
              </label>
            </div>
          </div>
        </div>
      </template>

      <!-- Step 2: Document Review -->
      <template if:true={isStep2}>
        <div class="step-container">
          <div class="slds-grid slds-grid_align-spread slds-m-bottom_medium">
            <div>
              <h3 class="slds-text-heading_medium">Review Document</h3>
              <p class="slds-text-body_small slds-text-color_weak">
                {documentMetadata.fileName} | {documentMetadata.pageCount} pages
              </p>
            </div>
            <div>
              <lightning-button variant="neutral" label="Previous" onclick={handlePreviousStep}></lightning-button>
            </div>
          </div>

          <div class="pdf-preview-container slds-m-bottom_medium">
            <iframe if:true={pdfPreviewUrl} src={pdfPreviewUrl} 
                    class="pdf-preview" width="100%" height="500px"></iframe>
          </div>

          <div class="review-checklist slds-box slds-theme_shade slds-m-bottom_medium">
            <h4 class="slds-text-heading_small slds-m-bottom_small">Pre-Signature Review Checklist</h4>
            <template for:each={requiredSignatureSteps} for:item="step" for:index="index">
              <div key={step} class="slds-form-element slds-m-bottom_x-small">
                <div class="slds-form-element__control">
                  <label class="slds-checkbox">
                    <input type="checkbox" class="review-checkbox" data-step={index} />
                    <span class="slds-checkbox_faux"></span>
                    <span class="slds-checkbox__label">
                      <span class="slds-form-element__label">{step}</span>
                    </span>
                  </label>
                </div>
              </div>
            </template>
          </div>

          <div class="slds-text-align_center">
            <lightning-button variant="destructive" label="Reject Document" 
                            onclick={handleRejectDocument} class="slds-m-right_small"></lightning-button>
            <lightning-button variant="brand" label="Approve & Sign" onclick={handleApproveDocument}></lightning-button>
          </div>
        </div>
      </template>

      <!-- Step 3: Create Signature -->
      <template if:true={isStep3}>
        <div class="step-container">
          <div class="slds-grid slds-grid_align-spread slds-m-bottom_medium">
            <div>
              <h3 class="slds-text-heading_medium">Create Your Signature</h3>
            </div>
            <div>
              <lightning-button variant="neutral" label="Previous" onclick={handlePreviousStep}></lightning-button>
            </div>
          </div>

          <!-- Signature Type Selection -->
          <div class="slds-form-element slds-m-bottom_medium">
            <fieldset class="slds-form-element">
              <legend class="slds-form-element__legend slds-form-element__label">Signature Method</legend>
              <div class="slds-form-element__control">
                <lightning-radio-group name="signatureMode" label="" options={signatureModeOptions} 
                                     value={signatureMode} onchange={handleSignatureTypeChange}></lightning-radio-group>
              </div>
            </fieldset>
          </div>

          <!-- Draw Signature -->
          <template if:true={isDraw}>
            <div class="signature-canvas-container slds-m-bottom_medium">
              <div class="slds-text-heading_small slds-m-bottom_small">Draw your signature below:</div>
              <div class="canvas-wrapper">
                <canvas class="signature-pad" width="400" height="150" 
                        style="border: 2px solid #d8dde6; background: white;"></canvas>
              </div>
              <div class="slds-m-top_small">
                <lightning-button variant="neutral" label="Clear" onclick={clearSignature}></lightning-button>
              </div>
            </div>
          </template>

          <!-- Type Signature -->
          <template if:true={isType}>
            <div class="slds-form-element slds-m-bottom_medium">
              <label class="slds-form-element__label">Type your full name:</label>
              <div class="slds-form-element__control">
                <lightning-input type="text" value={signatureText} onchange={handleTextSignatureChange} 
                               placeholder="Enter your full name"></lightning-input>
              </div>
            </div>
            <template if:true={signatureText}>
              <div class="typed-signature-preview slds-m-bottom_medium">
                <div class="signature-preview" style="font-family: cursive; font-size: 2rem; text-align: center; padding: 1rem; border: 2px solid #d8dde6;">
                  {signatureText}
                </div>
              </div>
            </template>
          </template>

          <div class="slds-text-align_center">
            <lightning-button variant="brand" label="Use This Signature" onclick={captureSignature}></lightning-button>
          </div>
        </div>
      </template>

      <!-- Step 4: Place Signature -->
      <template if:true={isStep4}>
        <div class="step-container">
          <div class="slds-grid slds-grid_align-spread slds-m-bottom_medium">
            <div>
              <h3 class="slds-text-heading_medium">Place Your Signature</h3>
              <p class="slds-text-body_small slds-text-color_weak">
                Click where you want to place your signature on the document
              </p>
            </div>
            <div>
              <lightning-button variant="neutral" label="Previous" onclick={handlePreviousStep}></lightning-button>
            </div>
          </div>

          <div class="pdf-signature-placement" style="position: relative;">
            <iframe if:true={pdfPreviewUrl} src={pdfPreviewUrl} 
                    class="pdf-preview" width="100%" height="600px"></iframe>
            <div class="pdf-overlay" onclick={handleSignaturePlacement} 
                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: crosshair;">
            </div>
          </div>

          <template if:true={placedSignatures.length}>
            <div class="slds-notify slds-notify_alert slds-alert_success slds-m-top_medium">
              <h2>✓ Signature placed successfully</h2>
            </div>
          </template>

          <div class="slds-text-align_center slds-m-top_medium">
            <lightning-button variant="neutral" label="Clear Signatures" 
                            onclick={clearAllSignatures} class="slds-m-right_small"></lightning-button>
            <lightning-button variant="brand" label="Save Signed Document" 
                            onclick={handleSaveSignedDocument} disabled={isSaving}></lightning-button>
          </div>
        </div>
      </template>

      <!-- Step 5: Completion -->
      <template if:true={isStep5}>
        <div class="step-container slds-text-align_center">
          <div class="slds-m-bottom_medium">
            <lightning-icon icon-name="utility:success" size="large" variant="success"></lightning-icon>
            <h3 class="slds-text-heading_medium slds-m-top_small">Signature Complete!</h3>
          </div>

          <template if:true={successMessage}>
            <div class="slds-notify slds-notify_alert slds-alert_success slds-m-bottom_medium">
              <h2>{successMessage}</h2>
            </div>
          </template>

          <div class="completion-summary slds-box slds-theme_success slds-m-bottom_medium">
            <h4 class="slds-text-heading_small">Signature Summary</h4>
            <p><strong>Document:</strong> {documentTypeLabel}</p>
            <p><strong>Signed by:</strong> {signerRoleLabel}</p>
            <p><strong>Date:</strong> {completionDate}</p>
            <p><strong>Workflow Stage:</strong> {workflowStage}</p>
          </div>

          <div class="slds-button-group">
            <lightning-button variant="neutral" label="View APD Record" onclick={navigateToAPDRecord}></lightning-button>
            <lightning-button variant="brand" label="Sign Another Document" onclick={handleStartOver}></lightning-button>
          </div>
        </div>
      </template>

      <!-- Error Display -->
      <template if:true={errorMessage}>
        <div class="slds-notify slds-notify_alert slds-alert_error slds-m-top_medium" role="alert">
          <h2>{errorMessage}</h2>
        </div>
      </template>

      <!-- Saving Spinner -->
      <template if:true={isSaving}>
        <div class="slds-spinner_container">
          <div role="status" class="slds-spinner slds-spinner_medium">
            <span class="slds-assistive-text">Saving signed document...</span>
            <div class="slds-spinner__dot-a"></div>
            <div class="slds-spinner__dot-b"></div>
          </div>
        </div>
      </template>
    </div>

    <!-- Progress Indicator -->
    <div class="slds-card__footer">
      <div class="slds-progress slds-progress_shade">
        <ol class="slds-progress__list">
          <li class={step0Class}>
            <span class="slds-progress__marker">
              <lightning-icon icon-name="utility:lock" size="x-small"></lightning-icon>
            </span>
            <span class="slds-progress__item_content slds-text-body_small">Validate</span>
          </li>
          <li class={step1Class}>
            <span class="slds-progress__marker">
              <lightning-icon icon-name="utility:upload" size="x-small"></lightning-icon>
            </span>
            <span class="slds-progress__item_content slds-text-body_small">Upload</span>
          </li>
          <li class={step2Class}>
            <span class="slds-progress__marker">
              <lightning-icon icon-name="utility:preview" size="x-small"></lightning-icon>
            </span>
            <span class="slds-progress__item_content slds-text-body_small">Review</span>
          </li>
          <li class={step3Class}>
            <span class="slds-progress__marker">
              <lightning-icon icon-name="utility:signature" size="x-small"></lightning-icon>
            </span>
            <span class="slds-progress__item_content slds-text-body_small">Sign</span>
          </li>
          <li class={step4Class}>
            <span class="slds-progress__marker">
              <lightning-icon icon-name="utility:touch_action" size="x-small"></lightning-icon>
            </span>
            <span class="slds-progress__item_content slds-text-body_small">Place</span>
          </li>
          <li class={step5Class}>
            <span class="slds-progress__marker">
              <lightning-icon icon-name="utility:success" size="x-small"></lightning-icon>
            </span>
            <span class="slds-progress__item_content slds-text-body_small">Complete</span>
          </li>
        </ol>
      </div>
    </div>
  </div>
</template>